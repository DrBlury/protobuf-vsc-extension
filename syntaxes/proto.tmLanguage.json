{
  "$schema": "https://raw.githubusercontent.com/martinring/tmlanguage/master/tmlanguage.json",
  "name": "Protocol Buffers",
  "scopeName": "source.proto",
  "patterns": [
    { "include": "#comments" },
    { "include": "#syntax" },
    { "include": "#edition" },
    { "include": "#package" },
    { "include": "#import" },
    { "include": "#option" },
    { "include": "#message" },
    { "include": "#enum" },
    { "include": "#service" },
    { "include": "#extend" },
    { "include": "#reserved" },
    { "include": "#extensions" },
    { "include": "#oneof" },
    { "include": "#map" },
    { "include": "#field" },
    { "include": "#rpc" },
    { "include": "#strings" },
    { "include": "#numbers" },
    { "include": "#constants" },
    { "include": "#types" }
  ],
  "repository": {
    "comments": {
      "patterns": [
        {
          "name": "comment.line.double-slash.proto",
          "match": "//.*$"
        },
        {
          "name": "comment.block.proto",
          "begin": "/\\*",
          "end": "\\*/"
        }
      ]
    },
    "syntax": {
      "match": "\\b(syntax)\\s*=\\s*(\"proto[23]\")",
      "captures": {
        "1": { "name": "keyword.control.syntax.proto" },
        "2": { "name": "string.quoted.double.proto" }
      }
    },
    "edition": {
      "match": "\\b(edition)\\s*=\\s*(\"[^\"]+\")",
      "captures": {
        "1": { "name": "keyword.control.edition.proto" },
        "2": { "name": "string.quoted.double.proto" }
      }
    },
    "package": {
      "match": "\\b(package)\\s+([\\w.]+)\\s*;",
      "captures": {
        "1": { "name": "keyword.control.package.proto" },
        "2": { "name": "entity.name.namespace.proto" }
      }
    },
    "import": {
      "match": "\\b(import)\\s+(weak|public)?\\s*(\"[^\"]+\")\\s*;",
      "captures": {
        "1": { "name": "keyword.control.import.proto" },
        "2": { "name": "keyword.other.import.modifier.proto" },
        "3": { "name": "string.quoted.double.proto" }
      }
    },
    "option": {
      "patterns": [
        {
          "comment": "Google API HTTP option with aggregate value",
          "begin": "\\b(option)\\s+(\\(google\\.api\\.http\\))\\s*=\\s*\\{",
          "end": "\\}\\s*;",
          "beginCaptures": {
            "1": { "name": "keyword.other.option.proto" },
            "2": { "name": "variable.other.option.googleapi.proto" }
          },
          "patterns": [{ "include": "#googleApiHttpBody" }]
        },
        {
          "comment": "Google API resource option with aggregate value",
          "begin": "\\b(option)\\s+(\\(google\\.api\\.resource\\))\\s*=\\s*\\{",
          "end": "\\}\\s*;",
          "beginCaptures": {
            "1": { "name": "keyword.other.option.proto" },
            "2": { "name": "variable.other.option.googleapi.proto" }
          },
          "patterns": [{ "include": "#googleApiResourceBody" }]
        },
        {
          "comment": "CEL validation option with aggregate value",
          "begin": "\\b(option)\\s+(\\([\\w.]+\\)(?:\\.[\\w]+)*)\\s*=\\s*\\{",
          "end": "\\}\\s*;",
          "beginCaptures": {
            "1": { "name": "keyword.other.option.proto" },
            "2": { "name": "variable.other.option.proto" }
          },
          "patterns": [{ "include": "#celOptionBody" }]
        },
        {
          "begin": "\\b(option)\\s+",
          "end": ";",
          "beginCaptures": {
            "1": { "name": "keyword.other.option.proto" }
          },
          "patterns": [
            { "include": "#optionName" },
            { "include": "#strings" },
            { "include": "#numbers" },
            { "include": "#constants" }
          ]
        }
      ]
    },
    "googleApiHttpBody": {
      "patterns": [
        { "include": "#comments" },
        {
          "comment": "HTTP method keywords (get, post, put, delete, patch)",
          "match": "\\b(get|post|put|delete|patch)\\s*:",
          "captures": {
            "1": { "name": "keyword.control.http.method.proto" }
          }
        },
        {
          "comment": "HTTP custom method block",
          "begin": "\\b(custom)\\s*:\\s*\\{",
          "end": "\\}",
          "beginCaptures": {
            "1": { "name": "keyword.control.http.method.proto" }
          },
          "patterns": [
            { "include": "#comments" },
            {
              "match": "\\b(kind|path)\\s*:",
              "captures": {
                "1": { "name": "support.type.property-name.http.proto" }
              }
            },
            { "include": "#strings" }
          ]
        },
        {
          "comment": "HTTP body and response_body fields",
          "match": "\\b(body|response_body)\\s*:",
          "captures": {
            "1": { "name": "support.type.property-name.http.proto" }
          }
        },
        {
          "comment": "Additional bindings block",
          "begin": "\\b(additional_bindings)\\s*\\{",
          "end": "\\}",
          "beginCaptures": {
            "1": { "name": "support.type.property-name.http.proto" }
          },
          "patterns": [{ "include": "#googleApiHttpBody" }]
        },
        {
          "comment": "HTTP path template variables",
          "match": "\\{([^}]+)\\}",
          "captures": {
            "0": { "name": "variable.parameter.path.proto" },
            "1": { "name": "variable.parameter.path.name.proto" }
          }
        },
        { "include": "#strings" },
        { "include": "#numbers" },
        { "include": "#constants" }
      ]
    },
    "googleApiResourceBody": {
      "patterns": [
        { "include": "#comments" },
        {
          "comment": "Resource property names",
          "match": "\\b(type|pattern|name_field|plural|singular|history|style)\\s*:",
          "captures": {
            "1": { "name": "support.type.property-name.resource.proto" }
          }
        },
        {
          "comment": "Resource history enum values",
          "match": "\\b(ORIGINALLY_SINGLE_PATTERN|FUTURE_MULTI_PATTERN)\\b",
          "name": "constant.language.resource.history.proto"
        },
        {
          "comment": "Resource style enum values",
          "match": "\\b(DECLARATIVE_FRIENDLY)\\b",
          "name": "constant.language.resource.style.proto"
        },
        {
          "comment": "Resource pattern variables",
          "match": "\\{([^}]+)\\}",
          "captures": {
            "0": { "name": "variable.parameter.resource.proto" },
            "1": { "name": "variable.parameter.resource.name.proto" }
          }
        },
        { "include": "#strings" },
        { "include": "#numbers" },
        { "include": "#constants" }
      ]
    },
    "celOptionBody": {
      "patterns": [
        { "include": "#comments" },
        {
          "comment": "CEL option field with string value containing CEL expression",
          "begin": "\\b(expression)\\s*:\\s*",
          "end": "(?=\\b(?:id|message|expression)\\s*:|\\})",
          "beginCaptures": {
            "1": { "name": "support.type.property-name.cel.proto" }
          },
          "patterns": [{ "include": "#celExpressionString" }]
        },
        {
          "comment": "CEL option field names",
          "match": "\\b(id|message)\\s*:",
          "captures": {
            "1": { "name": "support.type.property-name.cel.proto" }
          }
        },
        { "include": "#strings" },
        { "include": "#numbers" },
        { "include": "#constants" }
      ]
    },
    "celExpressionString": {
      "patterns": [
        {
          "comment": "CEL raw string literal (r\"...\" or R\"...\")",
          "name": "string.quoted.double.raw.cel.proto",
          "begin": "[rR]\"",
          "end": "\"",
          "patterns": [{ "include": "#celExpressionContent" }]
        },
        {
          "comment": "CEL triple-quoted string (\"\"\"...\"\"\")",
          "name": "string.quoted.double.triple.cel.proto",
          "begin": "\"\"\"",
          "end": "\"\"\"",
          "patterns": [{ "include": "#celExpressionContent" }]
        },
        {
          "comment": "CEL triple-quoted string ('''...''')",
          "name": "string.quoted.single.triple.cel.proto",
          "begin": "'''",
          "end": "'''",
          "patterns": [{ "include": "#celExpressionContent" }]
        },
        {
          "comment": "CEL bytes literal (b\"...\" or B\"...\")",
          "name": "string.quoted.double.bytes.cel.proto",
          "begin": "[bB]\"",
          "end": "\"",
          "patterns": [{ "include": "#celExpressionContent" }]
        },
        {
          "name": "string.quoted.double.cel.proto",
          "begin": "\"",
          "end": "\"",
          "patterns": [{ "include": "#celExpressionContent" }]
        },
        {
          "name": "string.quoted.single.cel.proto",
          "begin": "'",
          "end": "'",
          "patterns": [
            {
              "name": "constant.character.escape.proto",
              "match": "\\\\."
            }
          ]
        }
      ]
    },
    "celExpressionContent": {
      "patterns": [
        {
          "name": "constant.character.escape.proto",
          "match": "\\\\."
        },
        {
          "comment": "CEL this keyword",
          "name": "variable.language.this.cel.proto",
          "match": "\\bthis\\b"
        },
        {
          "comment": "CEL field access after this",
          "match": "(?<=this\\.)([a-zA-Z_][a-zA-Z0-9_]*)",
          "captures": {
            "1": { "name": "variable.other.property.cel.proto" }
          }
        },
        {
          "comment": "CEL built-in functions",
          "name": "support.function.cel.proto",
          "match": "\\b(has|size|exists|all|exists_one|filter|map|type|dyn|int|uint|double|bool|string|bytes|list|timestamp|duration|matches|startsWith|endsWith|contains|getDate|getDayOfMonth|getDayOfWeek|getDayOfYear|getFullYear|getHours|getMilliseconds|getMinutes|getMonth|getSeconds|null_type)\\b"
        },
        {
          "comment": "CEL comparison operators",
          "name": "keyword.operator.comparison.cel.proto",
          "match": "==|!=|<=|>=|<|>"
        },
        {
          "comment": "CEL logical operators",
          "name": "keyword.operator.logical.cel.proto",
          "match": "\\|\\||&&|!"
        },
        {
          "comment": "CEL arithmetic operators",
          "name": "keyword.operator.arithmetic.cel.proto",
          "match": "\\+|-|\\*|/|%"
        },
        {
          "comment": "CEL ternary operator",
          "name": "keyword.operator.ternary.cel.proto",
          "match": "\\?|:"
        },
        {
          "comment": "CEL membership operator",
          "name": "keyword.operator.membership.cel.proto",
          "match": "\\bin\\b"
        },
        {
          "comment": "CEL boolean literals",
          "name": "constant.language.boolean.cel.proto",
          "match": "\\b(true|false)\\b"
        },
        {
          "comment": "CEL null literal",
          "name": "constant.language.null.cel.proto",
          "match": "\\bnull\\b"
        },
        {
          "comment": "CEL hex integer literals (0x... or 0X...)",
          "name": "constant.numeric.hex.cel.proto",
          "match": "\\b-?0[xX][0-9a-fA-F]+([uU])?\\b"
        },
        {
          "comment": "CEL unsigned integer literals (123u or 123U)",
          "name": "constant.numeric.unsigned.cel.proto",
          "match": "\\b-?\\d+[uU]\\b"
        },
        {
          "comment": "CEL float literals with exponent",
          "name": "constant.numeric.float.cel.proto",
          "match": "\\b-?\\d*\\.\\d+([eE][+-]?\\d+)?\\b|\\b-?\\d+[eE][+-]?\\d+\\b"
        },
        {
          "comment": "CEL integer literals",
          "name": "constant.numeric.integer.cel.proto",
          "match": "\\b-?\\d+\\b"
        },
        {
          "comment": "CEL reserved words (cannot be used as identifiers)",
          "name": "keyword.reserved.cel.proto",
          "match": "\\b(as|break|const|continue|else|for|function|if|import|let|loop|package|namespace|return|var|void|while)\\b"
        },
        {
          "comment": "CEL list literal brackets",
          "name": "punctuation.definition.brackets.cel.proto",
          "match": "\\[|\\]"
        },
        {
          "comment": "CEL map/message literal braces",
          "name": "punctuation.definition.braces.cel.proto",
          "match": "\\{|\\}"
        },
        {
          "comment": "CEL identifiers (variables, field names)",
          "name": "variable.other.cel.proto",
          "match": "\\b[a-zA-Z_][a-zA-Z0-9_]*\\b"
        }
      ]
    },
    "optionName": {
      "patterns": [
        {
          "comment": "Google API option names",
          "match": "\\((google\\.api\\.(http|field_behavior|resource|resource_reference|method_signature|default_host|oauth_scopes))\\)",
          "captures": {
            "1": { "name": "variable.other.option.googleapi.proto" }
          }
        },
        {
          "match": "\\(([\\w.]+)\\)",
          "captures": {
            "1": { "name": "variable.other.option.proto" }
          }
        },
        {
          "match": "\\b(java_package|java_outer_classname|java_multiple_files|java_generate_equals_and_hash|java_string_check_utf8|optimize_for|go_package|cc_generic_services|java_generic_services|py_generic_services|php_generic_services|deprecated|cc_enable_arenas|objc_class_prefix|csharp_namespace|swift_prefix|php_class_prefix|php_namespace|php_metadata_namespace|ruby_package|features|unverified_lazy|debug_redact|retention|targets|edition_defaults|uninterpreted_option)\\b",
          "name": "support.other.option.proto"
        },
        {
          "comment": "Field behavior enum values",
          "match": "\\b(REQUIRED|OUTPUT_ONLY|INPUT_ONLY|IMMUTABLE|OPTIONAL|NON_EMPTY_DEFAULT|IDENTIFIER|UNORDERED_LIST)\\b",
          "name": "constant.language.field_behavior.proto"
        }
      ]
    },
    "message": {
      "patterns": [
        {
          "comment": "Message with brace on same line",
          "begin": "\\b(message)\\s+(\\w+)\\s*(\\{)",
          "end": "\\}",
          "beginCaptures": {
            "1": { "name": "keyword.declaration.message.proto" },
            "2": { "name": "entity.name.type.message.proto" },
            "3": { "name": "punctuation.definition.block.proto" }
          },
          "patterns": [
            { "include": "#comments" },
            { "include": "#option" },
            { "include": "#message" },
            { "include": "#enum" },
            { "include": "#oneof" },
            { "include": "#map" },
            { "include": "#reserved" },
            { "include": "#extensions" },
            { "include": "#extend" },
            { "include": "#field" }
          ]
        },
        {
          "comment": "Message with brace on next line (no brace on same line)",
          "begin": "\\b(message)\\s+(\\w+)(?=\\s*(?://.*)?$)",
          "end": "\\}",
          "beginCaptures": {
            "1": { "name": "keyword.declaration.message.proto" },
            "2": { "name": "entity.name.type.message.proto" }
          },
          "patterns": [
            { "include": "#comments" },
            { "include": "#option" },
            { "include": "#message" },
            { "include": "#enum" },
            { "include": "#oneof" },
            { "include": "#map" },
            { "include": "#reserved" },
            { "include": "#extensions" },
            { "include": "#extend" },
            { "include": "#field" }
          ]
        }
      ]
    },
    "enum": {
      "patterns": [
        {
          "comment": "Enum with brace on same line",
          "begin": "\\b(enum)\\s+(\\w+)\\s*(\\{)",
          "end": "\\}",
          "beginCaptures": {
            "1": { "name": "keyword.declaration.enum.proto" },
            "2": { "name": "entity.name.type.enum.proto" },
            "3": { "name": "punctuation.definition.block.proto" }
          },
          "patterns": [
            { "include": "#comments" },
            { "include": "#option" },
            { "include": "#enumValue" },
            { "include": "#reserved" }
          ]
        },
        {
          "comment": "Enum with brace on next line",
          "begin": "\\b(enum)\\s+(\\w+)(?=\\s*(?://.*)?$)",
          "end": "\\}",
          "beginCaptures": {
            "1": { "name": "keyword.declaration.enum.proto" },
            "2": { "name": "entity.name.type.enum.proto" }
          },
          "patterns": [
            { "include": "#comments" },
            { "include": "#option" },
            { "include": "#enumValue" },
            { "include": "#reserved" }
          ]
        }
      ]
    },
    "enumValue": {
      "match": "\\b(\\w+)\\s*=\\s*(-?\\d+)",
      "captures": {
        "1": { "name": "variable.other.enummember.proto" },
        "2": { "name": "constant.numeric.proto" }
      }
    },
    "service": {
      "patterns": [
        {
          "comment": "Service with brace on same line",
          "begin": "\\b(service)\\s+(\\w+)\\s*(\\{)",
          "end": "\\}",
          "beginCaptures": {
            "1": { "name": "keyword.declaration.service.proto" },
            "2": { "name": "entity.name.type.service.proto" },
            "3": { "name": "punctuation.definition.block.proto" }
          },
          "patterns": [
            { "include": "#comments" },
            { "include": "#option" },
            { "include": "#rpc" }
          ]
        },
        {
          "comment": "Service with brace on next line",
          "begin": "\\b(service)\\s+(\\w+)(?=\\s*(?://.*)?$)",
          "end": "\\}",
          "beginCaptures": {
            "1": { "name": "keyword.declaration.service.proto" },
            "2": { "name": "entity.name.type.service.proto" }
          },
          "patterns": [
            { "include": "#comments" },
            { "include": "#option" },
            { "include": "#rpc" }
          ]
        }
      ]
    },
    "rpc": {
      "begin": "\\b(rpc)\\s+(\\w+)\\s*\\(",
      "end": ";|\\{",
      "beginCaptures": {
        "1": { "name": "keyword.declaration.rpc.proto" },
        "2": { "name": "entity.name.function.rpc.proto" }
      },
      "patterns": [
        { "include": "#comments" },
        {
          "match": "\\b(stream)\\b",
          "name": "keyword.other.stream.proto"
        },
        {
          "match": "\\b(returns)\\b",
          "name": "keyword.control.returns.proto"
        },
        {
          "match": "\\b([A-Z]\\w*)\\b",
          "name": "entity.name.type.proto"
        }
      ]
    },
    "oneof": {
      "patterns": [
        {
          "comment": "Oneof with brace on same line",
          "begin": "\\b(oneof)\\s+(\\w+)\\s*(\\{)",
          "end": "\\}",
          "beginCaptures": {
            "1": { "name": "keyword.declaration.oneof.proto" },
            "2": { "name": "variable.other.oneof.proto" },
            "3": { "name": "punctuation.definition.block.proto" }
          },
          "patterns": [
            { "include": "#comments" },
            { "include": "#option" },
            { "include": "#field" }
          ]
        },
        {
          "comment": "Oneof with brace on next line",
          "begin": "\\b(oneof)\\s+(\\w+)(?=\\s*(?://.*)?$)",
          "end": "\\}",
          "beginCaptures": {
            "1": { "name": "keyword.declaration.oneof.proto" },
            "2": { "name": "variable.other.oneof.proto" }
          },
          "patterns": [
            { "include": "#comments" },
            { "include": "#option" },
            { "include": "#field" }
          ]
        }
      ]
    },
    "extend": {
      "patterns": [
        {
          "comment": "Extend with brace on same line",
          "begin": "\\b(extend)\\s+([\\w.]+)\\s*(\\{)",
          "end": "\\}",
          "beginCaptures": {
            "1": { "name": "keyword.declaration.extend.proto" },
            "2": { "name": "entity.name.type.proto" },
            "3": { "name": "punctuation.definition.block.proto" }
          },
          "patterns": [{ "include": "#comments" }, { "include": "#field" }]
        },
        {
          "comment": "Extend with brace on next line",
          "begin": "\\b(extend)\\s+([\\w.]+)(?=\\s*(?://.*)?$)",
          "end": "\\}",
          "beginCaptures": {
            "1": { "name": "keyword.declaration.extend.proto" },
            "2": { "name": "entity.name.type.proto" }
          },
          "patterns": [{ "include": "#comments" }, { "include": "#field" }]
        }
      ]
    },
    "reserved": {
      "match": "\\b(reserved)\\s+(.+);",
      "captures": {
        "1": { "name": "keyword.other.reserved.proto" },
        "2": {
          "patterns": [
            { "include": "#strings" },
            { "include": "#numbers" },
            {
              "match": "\\bto\\b",
              "name": "keyword.other.to.proto"
            },
            {
              "match": "\\bmax\\b",
              "name": "keyword.other.max.proto"
            }
          ]
        }
      }
    },
    "extensions": {
      "match": "\\b(extensions)\\s+(.+);",
      "captures": {
        "1": { "name": "keyword.other.extensions.proto" },
        "2": {
          "patterns": [
            { "include": "#numbers" },
            {
              "match": "\\bto\\b",
              "name": "keyword.other.to.proto"
            },
            {
              "match": "\\bmax\\b",
              "name": "keyword.other.max.proto"
            }
          ]
        }
      }
    },
    "map": {
      "match": "\\b(map)\\s*<\\s*(\\w+)\\s*,\\s*([\\w.]+)\\s*>\\s+(\\w+)\\s*=\\s*(\\d+)",
      "captures": {
        "1": { "name": "keyword.other.map.proto" },
        "2": { "name": "storage.type.proto" },
        "3": { "name": "entity.name.type.proto" },
        "4": { "name": "variable.other.field.proto" },
        "5": { "name": "constant.numeric.proto" }
      }
    },
    "field": {
      "patterns": [
        {
          "comment": "Field with inline CEL validation option",
          "begin": "\\b(optional|required|repeated)?\\s*([\\w.]+)\\s+(\\w+)\\s*=\\s*(\\d+)\\s*\\[\\s*(\\([\\w.]+\\)(?:\\.[\\w]+)*)\\s*=\\s*\\{",
          "end": "\\}\\s*\\]\\s*;",
          "beginCaptures": {
            "1": { "name": "keyword.other.modifier.proto" },
            "2": {
              "patterns": [
                { "include": "#types" },
                { "match": "[\\w.]+", "name": "entity.name.type.proto" }
              ]
            },
            "3": { "name": "variable.other.field.proto" },
            "4": { "name": "constant.numeric.proto" },
            "5": { "name": "variable.other.option.proto" }
          },
          "patterns": [{ "include": "#celOptionBody" }]
        },
        {
          "match": "\\b(optional|required|repeated)\\s+([\\w.]+)\\s+(\\w+)\\s*=\\s*(\\d+)",
          "captures": {
            "1": { "name": "keyword.other.modifier.proto" },
            "2": {
              "patterns": [
                { "include": "#types" },
                { "match": "[\\w.]+", "name": "entity.name.type.proto" }
              ]
            },
            "3": { "name": "variable.other.field.proto" },
            "4": { "name": "constant.numeric.proto" }
          }
        },
        {
          "match": "\\b([\\w.]+)\\s+(\\w+)\\s*=\\s*(\\d+)",
          "captures": {
            "1": {
              "patterns": [
                { "include": "#types" },
                { "match": "[\\w.]+", "name": "entity.name.type.proto" }
              ]
            },
            "2": { "name": "variable.other.field.proto" },
            "3": { "name": "constant.numeric.proto" }
          }
        }
      ]
    },
    "types": {
      "match": "\\b(double|float|int32|int64|uint32|uint64|sint32|sint64|fixed32|fixed64|sfixed32|sfixed64|bool|string|bytes)\\b",
      "name": "storage.type.proto"
    },
    "strings": {
      "patterns": [
        {
          "name": "string.quoted.double.proto",
          "begin": "\"",
          "end": "\"",
          "patterns": [
            {
              "name": "constant.character.escape.proto",
              "match": "\\\\."
            }
          ]
        },
        {
          "name": "string.quoted.single.proto",
          "begin": "'",
          "end": "'",
          "patterns": [
            {
              "name": "constant.character.escape.proto",
              "match": "\\\\."
            }
          ]
        }
      ]
    },
    "numbers": {
      "patterns": [
        {
          "name": "constant.numeric.hex.proto",
          "match": "\\b0[xX][0-9a-fA-F]+\\b"
        },
        {
          "name": "constant.numeric.octal.proto",
          "match": "\\b0[0-7]+\\b"
        },
        {
          "name": "constant.numeric.float.proto",
          "match": "\\b\\d+\\.\\d+([eE][+-]?\\d+)?\\b"
        },
        {
          "name": "constant.numeric.integer.proto",
          "match": "\\b-?\\d+\\b"
        }
      ]
    },
    "constants": {
      "match": "\\b(true|false|inf|nan)\\b",
      "name": "constant.language.proto"
    }
  }
}
